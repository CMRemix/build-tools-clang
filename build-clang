#!/usr/bin/env bash
# shellcheck disable=SC1117
# SPDX-License-Identifier: GPL-3.0-or-later
#
# Copyright (C) 2018 Nathan Chancellor
#                    Albert I (krasCGQ)
#                    Khusika Dhamar Gusti (khusika)
#
# Clang compilation script


###############
#             #
#  VARIABLES  #
#             #
###############

# Colors
BOLD="\033[1m"
GRN="\033[01;32m"
RED="\033[01;31m"
RST="\033[0m"

# Set linux username
VENDOR=$(echo $USER)

# Folder that will house the source and build files
MAIN_FOLDER=${HOME}/clang-build

# Folder that will hold the main LLVM source
LLVM_FOLDER=${MAIN_FOLDER}/llvm

# Folder that will hold all of the build files and compiled code
BUILD_FOLDER=${MAIN_FOLDER}/build

# Folder that will hold compiled toolchains
TC_FOLDER=${HOME}/toolchains

# Start tracking time
START=$(date +"%s")

# Number of threads
THREADS=$(nproc --all)

###############
#             #
#  FUNCTIONS  #
#             #
###############

# Alias for echo to print escape codes
function echo() {
    command echo -e "${@}"
}

# Help menu function
function help_menu() {
    echo
    echo "${BOLD}OVERVIEW:${RST} Build a Clang toolchain\n"
    echo "${BOLD}USAGE:${RST} ./$(basename ${0}) <options>\n"
    echo "${BOLD}EXAMPLE:${RST} ./$(basename ${0}) -a arm64\n"
    echo "${BOLD}REQUIRED PARAMETERS:${RST}"
    echo "  -a  | --arch:        Possible values: arm, arm64, x86, or all. This is the toolchain's target architecture."
    echo "${BOLD}OPTIONAL PARAMETERS:${RST}"
    echo "  -b  | --build-only:  Build only."
    echo "  -v  | --version:     Clang 7.x is compiled by default.\n"
}

# Prints a formatted header to point out what is being done to the user
function header() {
    if [[ -n ${2} ]]; then
        COLOR=${2}
    else
        COLOR=${RED}
    fi
    echo "${COLOR}"
    echo "====$(for i in $(seq ${#1}); do echo "=\c"; done)===="
    echo "==  ${1}  =="
    # SC2034: i appears unused. Verify it or export it.
    # shellcheck disable=SC2034
    echo "====$(for i in $(seq ${#1}); do echo "=\c"; done)===="
    echo "${RST}"
}

# Formats the time
function format_time() {
    MINS=$(((${2} - ${1}) / 60))
    SECS=$(((${2} - ${1}) % 60))
    if [[ ${MINS} -ge 60 ]]; then
        HOURS=$((MINS / 60))
        MINS=$((MINS % 60))
    fi

    if [[ ${HOURS} -eq 1 ]]; then
        TIME_STRING+="1 HOUR, "
    elif [[ ${HOURS} -ge 2 ]]; then
        TIME_STRING+="${HOURS} HOURS, "
    fi

    if [[ ${MINS} -eq 1 ]]; then
        TIME_STRING+="1 MINUTE"
    else
        TIME_STRING+="${MINS} MINUTES"
    fi

    if [[ ${SECS} -eq 1 && -n ${HOURS} ]]; then
        TIME_STRING+=", AND 1 SECOND"
    elif [[ ${SECS} -eq 1 && -z ${HOURS} ]]; then
        TIME_STRING+=" AND 1 SECOND"
    elif [[ ${SECS} -ne 1 && -n ${HOURS} ]]; then
        TIME_STRING+=", AND ${SECS} SECONDS"
    elif [[ ${SECS} -ne 1 && -z ${HOURS} ]]; then
        TIME_STRING+=" AND ${SECS} SECONDS"
    fi

    echo "${TIME_STRING}"
}

# Prints an error in bold red
function display_error() {
    echo
    echo "${RED}${1}${RST}"
    [[ -z ${2} ]] && echo
}

# Prints an error in bold red and exits the script
function die() {
    display_error "${@}"
    exit
}

# Enforces the value needed for two-part flags
function enforce_value() {
    [[ ${#} -lt 1 ]] && die "A additional value is needed for one of the flags passed to this script!"
}

function parse_parameters() {
    while [[ ${#} -ge 1 ]]; do
        case ${1} in
            # REQUIRED FLAGS
            "-a"|"--arch") shift && TARGET=${1} ;;

            # OPTIONAL FLAGS
            "-b"|"--build-only")
                BUILD_ONLY=true ;;
            "-d"|"--date")
                shift && enforce_value "${@}"
                DATE_OFFSET=${1} ;;
            "-i"|"--install-folder")
                shift && enforce_value "${@}"
                INSTALL_FOLDER=${1} ;;
            "-s"|"--stable")
                VERSION=6 ;;
            "-T"|"--test")
                TEST=true ;;
            "-u"|"--update-only")
                UPDATE_ONLY=true ;;

            # HELP!
            "-h"|"--help") help_menu; exit ;;

            *) die "Invalid parameter specified!" -h ;;
        esac

        shift
    done

    # Default values
    case "${TARGET}" in
        "arm") ARCH="ARM" ;;
        "arm64") ARCH="AArch64" ;;
        "i686") ARCH="X86" ;;
        "all") ARCH="X86;ARM;AArch64" ;;
        *) die "Absent or invalid arch specified!" -h ;;
    esac

    # Clang 7.x is compiled by default
    if [[ -z ${VERSION} ]]; then
        VERSION=7
    fi

    # Folder that will hold the final compiled toolchain
    [[ -z ${INSTALL_FOLDER} ]] && INSTALL_FOLDER=${TC_FOLDER}/${VENDOR}-clang-${VERSION}.x${TEST:+"-test"}

    # SVN copy of the LLVM folder for revisioning
    SVN_FOLDER=${MAIN_FOLDER}/svn-${VERSION}.x

    # Set compiler
    CC=$(command -v clang || command -v gcc)
    CXX=$(command -v clang++ || command -v g++)
    [[ -z ${CC} || -z ${CXX} ]] && die "Neither GCC nor Clang could be found on your system!"
}

# Syncs requested  projects
function sync() {
    FOLDER=${1}

    if [[ ${FOLDER} =~ "binutils" ]]; then
        URL=https://sourceware.org/git/binutils-gdb.git
        BRANCH=binutils-2_30-branch
    elif [[ ${FOLDER} =~ "svn" ]]; then
        case ${VERSION} in
            "7") URL=https://llvm.org/svn/llvm-project/llvm/trunk ;;
            *) URL=https://llvm.org/svn/llvm-project/llvm/branches/"release_${VERSION}0" ;;
        esac
    else
        LLVM_ORG=https://git.llvm.org/git/
        case ${FOLDER} in
            "clang"|"llvm")
                [[ $(uname -n) = "flashbox" ]] && URL_PREFIX=git@github.com: || URL_PREFIX=https://github.com/
                URL=${URL_PREFIX}nathanchance/$(basename "${FOLDER}").git ;;
            *)
                URL=${LLVM_ORG}$(basename "${FOLDER}") ;;
        esac

        case ${VERSION} in
            "7") BRANCH=master ;;
            *) BRANCH="release_${VERSION}0" ;;
        esac
    fi

    if [[ ! -d ${FOLDER} ]]; then
        case ${FOLDER} in
            *svn*)
                svn co "${URL}" "${FOLDER}" ;;
            "clang"|"llvm")
                git clone "${URL}" -b "${BRANCH}" "${FOLDER}"
                git -C "${FOLDER}" remote add upstream "${LLVM_ORG}$(basename "${FOLDER}")"
                git -C "${FOLDER}" fetch upstream
                git -C "${FOLDER}" rebase upstream/"${BRANCH}"
                [[ $(uname -n) = "flashbox" ]] && git -C "${FOLDER}" push -f ;;
            *)
                git clone "${URL}" -b "${BRANCH}" "${FOLDER}" ;;
        esac
    else
        (
            cd "${FOLDER}" || die "Error moving into ${FOLDER}"
            case ${FOLDER} in
                *svn*)
                    svn update ;;
                "clang"|"llvm")
                    if [[ -n ${DATE_OFFSET} ]]; then
                        git checkout "$(git log -1 --format=%H --before="$(date --date="-${DATE_OFFSET} day")")"
                        if [[ ${FOLDER} = "llvm" && ${VERSION} = 6 ]]; then
                            git cherry-pick 64e3da64729e
                        else
                            if [[ ${VERSION} -eq 6 ]]; then
                                git cherry-pick a095082d10de
                            else
                                git cherry-pick d049e5088911
                            fi
                        fi
                    else
                        git checkout ${BRANCH} || git checkout -b ${BRANCH} origin/${BRANCH}
                        add_remote upstream "${LLVM_ORG}$(basename "${FOLDER}")"
                        git fetch upstream
                        git rebase upstream/"${BRANCH}"
                        [[ $(uname -n) = "flashbox" ]] && git push -f
                    fi ;;
                *)
                    git clean -fxdq
                    if [[ -n ${DATE_OFFSET} ]]; then
                        git checkout "$(git log -1 --format=%H --before="$(date --date="-${DATE_OFFSET} day")")"
                    else
                        git checkout ${BRANCH}
                        git fetch origin
                        if ! git rebase origin/${BRANCH}; then
                            die "Error updating $(basename "${FOLDER}")!"
                        fi
                    fi ;;
            esac
        )
    fi
}

# Syncs all necessary projects
function sync_all() {
    header "Syncing projects"

    mkdir -p "${MAIN_FOLDER}"
    cd "${MAIN_FOLDER}" || die "Error creating ${MAIN_FOLDER}!"

    sync llvm
    sync "$(basename "${SVN_FOLDER}")"

    mkdir -p "${LLVM_FOLDER}/tools"
    cd "${LLVM_FOLDER}/tools" || die "Error creating tools folder!"

    sync binutils
    sync clang
    sync lld
    sync polly

    mkdir -p "${LLVM_FOLDER}/projects"
    cd "${LLVM_FOLDER}/projects" || die "Error creating projects folder!"

    sync compiler-rt
    sync libcxx
    sync libcxxabi
    sync libunwind
    sync openmp

    [[ -n ${UPDATE_ONLY} ]] && exit
}

# Removes any previous build files
function cleanup() {
    rm -rf "${BUILD_FOLDER}"
    mkdir -p "${BUILD_FOLDER}"
    cd "${BUILD_FOLDER}" || die "Error creating build folder!"
}

# Build the toolchain
function build() {
    header "Building Clang"

    cmake -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DLINK_POLLY_INTO_TOOLS=ON \
          -DCMAKE_C_COMPILER="${CC}" \
          -DCMAKE_C_FLAGS="-O3 -march=native -mtune=native" \
          -DCMAKE_CXX_COMPILER="${CXX}" \
          -DCMAKE_CXX_FLAGS="-O3 -march=native -mtune=native" \
          -DLLVM_ENABLE_PIC=ON \
          -DCMAKE_INSTALL_PREFIX="${INSTALL_FOLDER}" \
          -DLLVM_PARALLEL_COMPILE_JOBS="${THREADS}" \
          -DLLVM_PARALLEL_LINK_JOBS="${THREADS}" \
          -DLLVM_ENABLE_BINDINGS=OFF \
          -DLLVM_ENABLE_THREADS=ON \
          -DLLVM_ENABLE_WARNINGS=OFF \
          -DLLVM_ENABLE_WERROR=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_BINUTILS_INCDIR="${LLVM_FOLDER}/tools/binutils/include" \
          -DLLVM_TARGETS_TO_BUILD="${ARCH}" \
          -DLLVM_OPTIMIZED_TABLEGEN=ON \
          -DLLVM_USE_LINKER=gold \
          -DCLANG_VENDOR="${VENDOR} " \
          -DLLVM_VERSION_PATCH="$(cd "${SVN_FOLDER}" || die "SVN folder doesn't exist";
                                  svn info -r HEAD --show-item revision)" \
          -DLLVM_VERSION_SUFFIX="" \
          "${LLVM_FOLDER}"

    time ninja && SUCCESS=true
    TIME_STRING="$(format_time "${START}" "$(date +"%s")")"
    if [[ -n ${SUCCESS} ]]; then
        VERSION_STRING=$(${BUILD_FOLDER}/bin/clang --version | head -1 | perl -pe 's/\(http.*?\)//gs' | sed -e 's/  */ /g' -e 's/[[:space:]]*$//')
        header "SUCCESS!" "${GRN}"
        echo "${BOLD}Time elapsed:${RST} ${TIME_STRING,,}"
        echo
        echo "${BOLD}Version string:${RST} ${VERSION_STRING}"
        echo
    else
        header "ERROR BUILDING!"
        display_error "Time elapsed: ${TIME_STRING,,}"
        exit
    fi

    [[ -n ${BUILD_ONLY} ]] && exit
}

# Install the toolchain
function install() {

    if [[ -z ${TEST} ]]; then
        rm -rf "${INSTALL_FOLDER}-old"
        mv "${INSTALL_FOLDER}" "${INSTALL_FOLDER}-old"
    fi
    if ! ninja install &>/dev/null; then
        header "ERROR INSTALLING!"
        exit
    fi

    echo "${BOLD}Installation location:${RST} ${INSTALL_FOLDER}"
    echo
}

parse_parameters "${@}"
sync_all
cleanup
build
install
